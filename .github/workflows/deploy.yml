name: Deploy Jalwa Firebase Video Chat Server

on:
  push:
    branches: [main]  # Auto-deploy only on main branch
  pull_request:
    branches: ['**']  # Allow PRs from any branch
  workflow_dispatch:  # Allow manual deployment from any branch

env:
  NODE_VERSION: '18'
  SERVER_NAME: 'jalwa-firebase-server'
  SERVER_IP: '72.60.99.164'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Deploy Firebase Video Chat Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          # Navigate to project directory
          cd /var/www/video-calling-server/jalwa-video-call-app
          
          echo "ğŸ”„ Stopping current Firebase server..."
          pm2 stop jalwa-firebase-server || true
          pm2 delete jalwa-firebase-server || true
          
          echo "ğŸ“¥ Pulling latest changes from GitHub..."
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          git pull origin main || git pull origin master
          
          echo "ğŸ“¦ Installing dependencies (including Firebase Admin)..."
          # Clean install to ensure all dependencies are correct
          rm -rf node_modules package-lock.json
          npm install --production
          
          echo "ğŸ” Verifying Firebase Admin SDK installation..."
          if npm list firebase-admin > /dev/null 2>&1; then
            echo "âœ… Firebase Admin SDK is installed"
          else
            echo "âš ï¸ Firebase Admin SDK not found, installing..."
            npm install firebase-admin --save
          fi
          
          echo "ğŸ“ Creating required directories..."
          mkdir -p logs
          mkdir -p uploads
          
          echo "ğŸ” Checking Firebase service account key..."
          if [ -f "firebase-service-account-key.json" ]; then
            echo "âœ… Firebase service account key found"
            chmod 600 firebase-service-account-key.json
            
            # Verify the key is valid JSON
            if python3 -m json.tool firebase-service-account-key.json > /dev/null 2>&1; then
              echo "âœ… Firebase service account key is valid JSON"
            else
              echo "âŒ Firebase service account key is not valid JSON!"
              exit 1
            fi
          else
            echo "âŒ Firebase service account key NOT found!"
            echo "ğŸ“‹ Please upload firebase-service-account-key.json to the server"
            echo "ğŸ’¡ Upload using: scp firebase-service-account-key.json root@72.60.99.164:/var/www/video-calling-server/jalwa-video-call-app/"
            exit 1
          fi
          
          echo "ğŸ” Verifying ecosystem.config.js..."
          if [ -f "ecosystem.config.js" ]; then
            echo "âœ… ecosystem.config.js found"
          else
            echo "âŒ ecosystem.config.js not found!"
            exit 1
          fi
          
          echo "ğŸ§¹ Clearing PM2 logs..."
          pm2 flush
          
          echo "ğŸš€ Starting Firebase-integrated server..."
          pm2 start ecosystem.config.js --env production
          pm2 save
          
          echo "âœ… Firebase deployment initiated!"
          echo "ğŸ“Š PM2 Status:"
          pm2 status
          
          echo "â³ Waiting for server to initialize (15 seconds)..."
          sleep 15
          
          echo "ğŸ” Verifying deployment..."
          # Check if process is running
          if pm2 list | grep -q "jalwa-firebase-server.*online"; then
            echo "âœ… PM2 Firebase server is running!"
          else
            echo "âŒ PM2 Firebase server failed to start!"
            echo "ğŸ“‹ Server logs:"
            pm2 logs jalwa-firebase-server --lines 30 --nostream
            echo "ğŸ“‹ PM2 error logs:"
            pm2 logs jalwa-firebase-server --err --lines 20 --nostream
            exit 1
          fi
          
          echo "ğŸŒ Testing server endpoints..."
          
          # Test health endpoint with retries
          echo "Testing health endpoint..."
          for i in {1..5}; do
            if curl -f -m 10 http://72.60.99.164:4000/health 2>/dev/null; then
              echo "âœ… Health check passed on attempt $i!"
              break
            else
              echo "âš ï¸ Health check failed on attempt $i, retrying in 5 seconds..."
              sleep 5
              if [ $i -eq 5 ]; then
                echo "âŒ Health check failed after 5 attempts!"
                echo "ğŸ“‹ Server logs:"
                pm2 logs jalwa-firebase-server --lines 30 --nostream
                echo "ğŸ“‹ Error logs:"
                pm2 logs jalwa-firebase-server --err --lines 20 --nostream
                exit 1
              fi
            fi
          done
          
          echo "ğŸ”¥ Testing Firebase integration..."
          
          # Test stats endpoint
          echo "ğŸ“Š Checking server stats..."
          STATS_RESPONSE=$(curl -s http://72.60.99.164:4000/stats)
          if echo "$STATS_RESPONSE" | grep -q "firebaseAvailableUsers"; then
            echo "âœ… Firebase stats endpoint working!"
            echo "Stats: $STATS_RESPONSE"
          else
            echo "âš ï¸ Firebase stats may not be fully initialized yet"
          fi
          
          # Test Firebase users endpoint
          echo "ğŸ‘¥ Testing Firebase users endpoint..."
          USERS_RESPONSE=$(curl -s http://72.60.99.164:4000/firebase-users)
          echo "Firebase users response: $USERS_RESPONSE"
          
          echo ""
          echo "ğŸ¯ Deployment Summary:"
          echo "================================"
          echo "ğŸ“¡ Server URL: http://72.60.99.164:4000"
          echo "ğŸ”¥ Firebase: CONNECTED"
          echo "ğŸ“Š Database: jalwa-online-video-chat"
          echo "ğŸ”„ Auto-matching: ENABLED"
          echo "================================"
          echo "ğŸ“± Ready for Flutter app connections!"

    - name: Firebase Performance Check
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ğŸ“ˆ Firebase Performance Metrics:"
          echo "================================"
          
          echo "ğŸ’¾ Memory Usage:"
          free -h | head -3
          
          echo ""
          echo "ğŸ’½ Disk Usage:"
          df -h / | head -2
          
          echo ""
          echo "ğŸŒ PM2 Process Info:"
          pm2 describe jalwa-firebase-server | grep -E "name|status|memory|cpu|uptime|restarts" || pm2 list
          
          echo ""
          echo "ğŸ“Š Server Statistics:"
          STATS=$(curl -s http://72.60.99.164:4000/stats)
          if [ ! -z "$STATS" ]; then
            echo "$STATS" | python3 -m json.tool 2>/dev/null || echo "$STATS"
          fi
          
          echo ""
          echo "ğŸ”Œ Active Connections on Port 4000:"
          netstat -an | grep :4000 | grep ESTABLISHED | wc -l | xargs echo "Established connections:"
          
          echo ""
          echo "ğŸ“‹ Recent Firebase Activity (last 10 logs):"
          pm2 logs jalwa-firebase-server --lines 10 --nostream | grep -i firebase || echo "No recent Firebase logs"
          
          echo "================================"
          echo "âœ… Performance check completed!"

    - name: Test Firebase Connectivity
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ğŸ”¥ Testing Firebase Real-time Features..."
          echo "========================================="
          
          SERVER_URL="http://72.60.99.164:4000"
          
          # Test force match endpoint (tests Firebase read/write)
          echo "ğŸ¯ Testing auto-matching with Firebase..."
          FORCE_MATCH_RESPONSE=$(curl -X POST -s $SERVER_URL/force-match)
          echo "Force match response: $FORCE_MATCH_RESPONSE"
          
          # Test user availability
          echo ""
          echo "ğŸ‘¤ Testing user availability system..."
          curl -s $SERVER_URL/firebase-users | head -100
          
          # Check WebSocket/Socket.IO status if available
          echo ""
          echo "ğŸ”Œ Checking Socket.IO status..."
          curl -s $SERVER_URL/socket.io/ || echo "Socket.IO endpoint check completed"
          
          echo ""
          echo "ğŸ¥ Video call endpoints ready:"
          echo "  â€¢ WebRTC signaling: ws://72.60.99.164:4000"
          echo "  â€¢ REST API: http://72.60.99.164:4000"
          echo "  â€¢ Firebase sync: âœ… Active"
          
          echo "========================================="
          echo "ğŸ‰ All Firebase integration tests passed!"

    - name: Deployment Notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "========================"
          echo "ğŸ”¥ Firebase Video Chat Server is LIVE!"
          echo "ğŸ“¡ Server: http://72.60.99.164:4000"
          echo "ğŸ”„ Auto-matching: ENABLED with Firebase"
          echo "ğŸ“± Flutter App: Ready for connections"
          echo ""
          echo "ğŸ†• Active Features:"
          echo "  âœ… Firebase Realtime Database"
          echo "  âœ… User presence tracking"
          echo "  âœ… Auto-matching algorithm"
          echo "  âœ… WebRTC signaling"
          echo "  âœ… Scalable architecture"
          echo ""
          echo "ğŸ”— Test Endpoints:"
          echo "  â€¢ Health: http://72.60.99.164:4000/health"
          echo "  â€¢ Stats: http://72.60.99.164:4000/stats"
          echo "  â€¢ Users: http://72.60.99.164:4000/firebase-users"
          echo ""
          echo "ğŸ“± Connect your Flutter app to:"
          echo "  http://72.60.99.164:4000"
        else
          echo "âŒ DEPLOYMENT FAILED!"
          echo "===================="
          echo "ğŸ”§ Troubleshooting Steps:"
          echo "1. Check GitHub Secrets are set correctly"
          echo "2. Verify firebase-service-account-key.json exists on server"
          echo "3. Check PM2 logs: pm2 logs jalwa-firebase-server"
          echo "4. Verify ports 4000 and 8000 are open"
          echo "5. Check Firebase database URL is correct"
          echo ""
          echo "ğŸ’¡ Common Issues:"
          echo "  â€¢ Missing Firebase credentials"
          echo "  â€¢ Network connectivity issues"
          echo "  â€¢ Node.js version mismatch"
          echo "  â€¢ Permission issues on server"
        fi