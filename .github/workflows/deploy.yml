name: Deploy Jalwa Firebase Video Chat Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy Firebase-integrated server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd /var/www/video-calling-server/jalwa-video-call-app
          
          echo "ðŸ”„ Stopping current servers..."
          pm2 stop jalwa-auto-connect-server || true
          pm2 stop jalwa-firebase-server || true
          pm2 stop webrtc-server || true
          pm2 delete jalwa-auto-connect-server || true
          pm2 delete jalwa-firebase-server || true
          pm2 delete webrtc-server || true
          
          echo "ðŸ“¥ Pulling latest Firebase-integrated changes..."
          git pull origin main
          
          echo "ðŸ“¦ Installing dependencies (including Firebase Admin)..."
          # FIXED: Remove package-lock.json if it exists and use npm install instead of npm ci
          if [ -f "package-lock.json" ]; then
            echo "ðŸ—‘ï¸ Removing outdated package-lock.json..."
            rm package-lock.json
          fi
          
          # Use npm install to generate new package-lock.json that matches package.json
          npm install --omit=dev
          
          echo "ðŸ“ Creating logs directory..."
          mkdir -p logs
          
          echo "ðŸ” Checking Firebase service account key..."
          if [ -f "firebase-service-account-key.json" ]; then
            echo "âœ… Firebase service account key found"
            chmod 600 firebase-service-account-key.json
            
            # Verify the key is valid JSON
            if python3 -m json.tool firebase-service-account-key.json > /dev/null 2>&1; then
              echo "âœ… Firebase service account key is valid JSON"
            else
              echo "âŒ Firebase service account key is not valid JSON!"
              exit 1
            fi
          else
            echo "âŒ Firebase service account key NOT found!"
            echo "ðŸ“‹ Please upload firebase-service-account-key.json to the server"
            echo "ðŸ’¡ You can upload it using: scp firebase-service-account-key.json root@147.93.108.247:/var/www/video-calling-server/jalwa-video-call-app/"
            exit 1
          fi
          
          echo "ðŸ” Verifying Firebase dependency installation..."
          if npm list firebase-admin > /dev/null 2>&1; then
            echo "âœ… Firebase Admin SDK is installed"
          else
            echo "âŒ Firebase Admin SDK not found, installing..."
            npm install firebase-admin --save
          fi
          
          echo "ðŸ§¹ Clearing PM2 logs..."
          pm2 flush
          
          echo "ðŸš€ Starting Firebase-integrated server..."
          pm2 start ecosystem.config.js --env production
          pm2 save
          
          echo "âœ… Firebase deployment completed!"
          pm2 status
          
          echo "â³ Waiting for server to start..."
          sleep 15
          
          # Check if process is running
          if pm2 list | grep -q "jalwa-firebase-server.*online"; then
            echo "âœ… PM2 Firebase server is running!"
          else
            echo "âŒ PM2 Firebase server failed to start!"
            echo "ðŸ“‹ Server logs:"
            pm2 logs jalwa-firebase-server --lines 20
            echo "ðŸ“‹ PM2 error logs:"
            pm2 logs jalwa-firebase-server --err --lines 10
            exit 1
          fi
          
          echo "ðŸ” Testing Firebase-integrated server..."
          # Test health endpoint with retries
          for i in {1..5}; do
            if curl -f http://147.93.108.247:4000/health; then
              echo "âœ… Health check passed on attempt $i!"
              break
            else
              echo "âš ï¸ Health check failed on attempt $i, retrying..."
              sleep 5
              if [ $i -eq 5 ]; then
                echo "âŒ Health check failed after 5 attempts!"
                echo "ðŸ“‹ Server logs:"
                pm2 logs jalwa-firebase-server --lines 20
                echo "ðŸ“‹ Error logs:"
                pm2 logs jalwa-firebase-server --err --lines 10
                exit 1
              fi
            fi
          done
          
          # Test Firebase-specific endpoints
          echo "ðŸ”¥ Testing Firebase integration..."
          
          echo "ðŸ“Š Checking server stats..."
          if curl -s http://147.93.108.247:4000/stats | grep -q "firebaseAvailableUsers"; then
            echo "âœ… Firebase stats endpoint working!"
          else
            echo "âš ï¸ Firebase stats may not be fully working"
            echo "ðŸ“‹ Stats response:"
            curl -s http://147.93.108.247:4000/stats || echo "Failed to get stats"
          fi
          
          echo "ðŸ‘¥ Testing Firebase users endpoint..."
          curl -s http://147.93.108.247:4000/firebase-users || echo "âš ï¸ Firebase users endpoint check"
          
          echo "ðŸŽ¯ Firebase-integrated Jalwa server is running!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ðŸŽ‰ Firebase deployment successful!"
          echo "ðŸ”¥ Firebase-integrated video chat server is live!"
          echo "ðŸ“¡ Server: http://147.93.108.247:4000"
          echo "ðŸ”„ Auto-matching: ENABLED with Firebase"
          echo "ðŸ“± Ready for Flutter app with Firebase Auth!"
          echo ""
          echo "ðŸ†• New Features:"
          echo "  â€¢ Firebase Realtime Database integration"
          echo "  â€¢ Real-time user presence tracking"
          echo "  â€¢ Enhanced auto-matching algorithm"
          echo "  â€¢ Scalable user management"
          echo ""
          echo "ðŸ”— Test endpoints:"
          echo "  â€¢ Health: http://147.93.108.247:4000/health"
          echo "  â€¢ Stats: http://147.93.108.247:4000/stats"
          echo "  â€¢ Firebase Users: http://147.93.108.247:4000/firebase-users"
        else
          echo "âŒ Firebase deployment failed!"
          echo "ðŸ”§ Please check the server logs"
          echo "ðŸ’¡ Common issues:"
          echo "  â€¢ Missing firebase-service-account-key.json"
          echo "  â€¢ Incorrect Firebase database URL in ecosystem.config.js"
          echo "  â€¢ Network connectivity to Firebase"
          echo "  â€¢ Package dependency conflicts"
          echo "  â€¢ Invalid Firebase service account key format"

    - name: Firebase performance check
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ðŸ“ˆ Firebase Performance Metrics:"
          echo ""
          echo "ðŸ’¾ Memory usage:"
          free -h | head -2
          echo ""
          echo "ðŸŒ PM2 process info:"
          pm2 list | grep jalwa || echo "Process check completed"
          echo ""
          echo "ðŸ“Š Server health check:"
          curl -s http://147.93.108.247:4000/health | python3 -m json.tool 2>/dev/null || curl -s http://147.93.108.247:4000/health
          echo ""
          echo "ðŸ”¥ Firebase-specific metrics:"
          curl -s http://147.93.108.247:4000/stats | python3 -c "
          import sys, json
          try:
              data = json.load(sys.stdin)
              print(f'Firebase Available Users: {data.get(\"firebaseAvailableUsers\", \"N/A\")}')
              print(f'Socket Connections: {data.get(\"socketConnections\", \"N/A\")}')
              print(f'Active Rooms: {data.get(\"activeRooms\", \"N/A\")}')
          except:
              print('Could not parse JSON response')
          " 2>/dev/null || echo "Metrics retrieved"
          echo ""
          echo "ðŸŽ¯ Firebase performance check completed!"

    - name: Test Firebase connectivity
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ðŸ”¥ Testing Firebase connectivity..."
          
          # Test force match endpoint (this will test Firebase read/write)
          echo "ðŸŽ¯ Testing auto-matching with Firebase..."
          curl -X POST -s http://147.93.108.247:4000/force-match | python3 -m json.tool 2>/dev/null || curl -X POST -s http://147.93.108.247:4000/force-match
          
          echo ""
          echo "âœ… Firebase connectivity test completed!"
          
          # Show recent logs for any Firebase errors
          echo "ðŸ“‹ Recent server logs (last 10 lines):"
          pm2 logs jalwa-firebase-server --lines 10 --nostream || echo "Logs retrieved"
          
          echo ""
          echo "ðŸ“‹ Recent error logs (if any):"
          pm2 logs jalwa-firebase-server --err --lines 5 --nostream || echo "No recent errors"