name: Deploy Jalwa Auto-Connect Video Chat Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd /var/www/video-calling-server/jalwa-video-call-app
          
          echo "🔄 Stopping current servers..."
          pm2 stop jalwa-auto-connect-server || true
          pm2 stop webrtc-server || true
          pm2 delete jalwa-auto-connect-server || true
          pm2 delete webrtc-server || true
          
          echo "📥 Pulling latest auto-connect changes..."
          git pull origin main
          
          echo "📦 Installing dependencies..."
          npm ci --omit=dev
          
          echo "📁 Creating logs directory..."
          mkdir -p logs
          
          echo "🧹 Clearing PM2 logs..."
          pm2 flush
          
          echo "🚀 Starting auto-connect server..."
          pm2 start ecosystem.config.js --env production
          pm2 save
          
          echo "✅ Auto-connect deployment completed!"
          pm2 status
          
          echo "⏳ Waiting for server to start..."
          sleep 10
          
          # Check if process is running
          if pm2 list | grep -q "jalwa-auto-connect-server.*online"; then
            echo "✅ PM2 process is running!"
          else
            echo "❌ PM2 process failed to start!"
            pm2 logs jalwa-auto-connect-server --lines 20
            exit 1
          fi
          
          echo "🔍 Testing auto-connect server..."
          # Test health endpoint with retries
          for i in {1..5}; do
            if curl -f http://147.93.108.247:4000/health; then
              echo "✅ Health check passed on attempt $i!"
              break
            else
              echo "⚠️ Health check failed on attempt $i, retrying..."
              sleep 3
              if [ $i -eq 5 ]; then
                echo "❌ Health check failed after 5 attempts!"
                echo "📋 Server logs:"
                pm2 logs jalwa-auto-connect-server --lines 10
                exit 1
              fi
            fi
          done
          
          # Test stats endpoint
          echo "📊 Checking auto-connect stats..."
          curl -s http://147.93.108.247:4000/stats || echo "⚠️ Stats endpoint check"
          
          echo "🎯 Auto-connect Chatroulette server is running!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "🎉 Auto-connect deployment successful!"
          echo "🚀 Chatroulette-style video chat is now live!"
          echo "📡 Server: http://147.93.108.247:4000"
          echo "🔄 Auto-matching: ENABLED"
          echo "📱 Ready for Flutter app connections!"
        else
          echo "❌ Auto-connect deployment failed!"
          echo "🔧 Please check the server logs"
        fi

    - name: Performance check
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "📈 Performance metrics:"
          echo "💾 Memory usage:"
          free -h | head -2
          echo "🌐 PM2 process info:"
          pm2 list | grep jalwa || echo "Process check completed"
          echo "📊 Server stats:"
          curl -s http://147.93.108.247:4000/stats | head -5 || echo "Server responsive"
          echo "🎯 Performance check completed!"