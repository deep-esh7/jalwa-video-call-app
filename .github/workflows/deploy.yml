name: Deploy Jalwa Auto-Connect Video Chat Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd /var/www/video-calling-server/jalwa-video-call-app
          
          echo "ğŸ”„ Stopping current auto-connect server..."
          pm2 stop jalwa-auto-connect-server || pm2 stop webrtc-server || true
          
          echo "ğŸ“¥ Pulling latest auto-connect changes..."
          git pull origin main
          
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --production
          
          echo "ğŸ§¹ Clearing PM2 logs..."
          pm2 flush
          
          echo "ğŸš€ Starting auto-connect server..."
          pm2 start ecosystem.config.js --env production
          pm2 save
          
          echo "âœ… Auto-connect deployment completed!"
          pm2 status
          
          echo "ğŸ” Testing auto-connect server..."
          sleep 5
          
          # Test health endpoint
          if curl -f http://147.93.108.247:4000/health; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed!"
            exit 1
          fi
          
          # Test stats endpoint to verify auto-matching
          echo "ğŸ“Š Checking auto-connect stats..."
          if curl -s http://147.93.108.247:4000/stats | jq '.autoMatchingActive // "unknown"' 2>/dev/null; then
            echo "âœ… Auto-matching status verified!"
          else
            echo "âš ï¸ Stats endpoint working (jq not available)"
            curl -s http://147.93.108.247:4000/stats || echo "ğŸ“Š Stats endpoint responsive"
          fi
          
          echo "ğŸ¯ Auto-connect Chatroulette server is running!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ Auto-connect deployment successful!"
          echo "ğŸš€ Chatroulette-style video chat is now live!"
          echo "ğŸ“¡ Server: http://147.93.108.247:4000"
          echo "ğŸ”„ Auto-matching: ENABLED"
          echo "ğŸ“± Ready for Flutter app connections!"
        else
          echo "âŒ Auto-connect deployment failed!"
          echo "ğŸ”§ Please check the logs and try again"
        fi

    - name: Performance check
      if: success()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          echo "ğŸ“ˆ Performance metrics:"
          echo "ğŸ’¾ Memory usage:"
          free -h | head -2
          echo "ğŸ’» CPU usage:"
          top -bn1 | grep "Cpu(s)" | awk '{print $2 $3 $4 $5}' || echo "CPU info unavailable"
          echo "ğŸŒ PM2 process info:"
          pm2 list | grep jalwa || pm2 list | grep webrtc || echo "PM2 process check"
          echo "ğŸ“Š Server stats:"
          if command -v jq >/dev/null 2>&1; then
            curl -s http://147.93.108.247:4000/stats | jq '{connectedUsers, waitingUsers, activeMatches, autoMatchingActive}' 2>/dev/null || echo "Stats parsing failed"
          else
            echo "ğŸ“Š Raw server stats:"
            curl -s http://147.93.108.247:4000/stats | head -10 || echo "Server stats unavailable"
          fi
          echo "ğŸ¯ Performance check completed!"